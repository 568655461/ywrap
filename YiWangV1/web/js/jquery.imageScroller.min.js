(function (a) {
    a.fn.imageScroller = function (m) {
        var j = a.extend({}, a.fn.imageScroller.defaults, m);
        return this.each(function () {
            var c = a(this),
                f = a.meta ? a.extend({}, j, c.data()) : j,
                k = c.height(),
                kX = c.width(),
                g = c.find(f.preview),
                n = g.offset(),
                e = g.height(),
                eX = g.width(),
                l = c.find("img" + f.featureImg),
                hX = l.attr('data_width_3d'),
                h = l.attr('data_height_3d'),
                c = k / h;

            e = eX / hX * h;
            g.css('height', e + 'px');

            if ($("#pictures_big").attr('data_index') == 1) {
                var cX = 1;
            } else {
                var cX = kX / hX;
            }
            var i = Math.round(e * c);
            var iX = Math.round(eX * cX);            

            if (h > k) {
                $(f.preview).find('.indicator').remove();
                var d = a("<span/>", {
                    "class": "indicator",
                    css: {
                        opacity: 0.4,
                        height: i,
                        width: iX,
                        top: 0
                    }
                });

                a("<span/>", {
                    text: f.indicatorText,
                    css: {
                        height: i,
                        lineHeight: i + 'px',
                        fontSize: '14px'
                    }
                }).appendTo(d);
                d.appendTo(g);
                d.bind({
                    mousedown: function (o) {
                        var p = d.offset();
                        a(document).bind({
                            "mousemove.dragging": function (b) {
                                var by = b.pageY - n.top - (o.pageY - p.top);
                                if (by <= 0) by = 0;
                                else if (by >= e - i) by = e - i;
                                //d.css("top", by);

                                var bx = b.pageX - n.left - (o.pageX - p.left);
                                if (bx <= 0) bx = 0;
                                else if (bx >= eX - iX) bx = eX - iX;
                                d.css({ left: bx, top: by });


                                l.stop().animate({
                                    top: "-" + Math.round(by / e * h),
                                    left: "-" + Math.round(bx / eX * hX)
                                }, 10)
                            },
                            mouseup: function () {
                                a(document).unbind("mousemove.dragging")
                            }
                        })
                    }
                })
            }
        })
    };
    a.fn.imageScroller.defaults = {
        preview: ".preview",
        featureImg: ".feature-image",
        indicatorText: "拖动"
    }
})(jQuery);