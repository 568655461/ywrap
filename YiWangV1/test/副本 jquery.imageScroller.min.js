(function (a) {
    a.fn.imageScroller = function (m) {
        var j = a.extend({}, a.fn.imageScroller.defaults, m);
        return this.each(function () {
            var c = a(this),
                f = a.meta ? a.extend({}, j, c.data()) : j,

                //预览大图片的div宽高 应该跟span必须成比例
                k = c.height(),
                kX = c.width(),

                //找到预览的对象
                g = c.find(f.preview),
                n = g.offset(),


                //预览对象的宽高
                e = g.height(),
                eX = g.width(),

                //内部大图片
                l = c.find("img" + f.featureImg),

                h = l.height(),
                hX = l.width();


            c = k / h;
            var cX = kX / hX;

            var i = Math.round(e * c);
            var iX = Math.round(eX * cX);

            if (h > k) {
                var d = a("<span/>", {
                    "class": "indicator",
                    css: {
                        opacity: 0.4,
                        height: i,
                        width: iX
                    }
                });

                a("<span/>", {
                    text: f.indicatorText
                }).appendTo(d);
                d.appendTo(g);
                d.bind({
                    mousedown: function (o) {
                        var p = d.offset();
                        a(document).bind({
                            "mousemove.dragging": function (b) {
                                var by = b.pageY - n.top - (o.pageY - p.top);
                                if (by <= 0) by = 0;
                                else if (by >= e - i) by = e - i;
                               

                                var bx = b.pageX - n.left - (o.pageX - p.left);
                                if (bx <= 0) bx = 0;
                                else if (bx >= eX - iX) bx = eX - iX;


                                d.css({ left: bx,top:by});


                                l.stop().animate({
                                    top: "-" + Math.round(by / e * h),
                                    left: "-" + Math.round(bx / eX * hX)
                                }, 10)
                            },
                            mouseup: function () {
                                a(document).unbind("mousemove.dragging")
                            }
                        })
                    }
                })
            }
        })
    };
    a.fn.imageScroller.defaults = {
        preview: ".preview",
        featureImg: ".feature-image",
        indicatorText: "Drag Me"
    }
})(jQuery);